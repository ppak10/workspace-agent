name: pytest

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version:
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"

    steps:
    - name: Check out repository code
      uses: actions/checkout@v4

    - name: Set up UV
      uses: astral-sh/setup-uv@v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install MCP Client Dependencies
      run: npm install -g @anthropic-ai/claude-code @openai/codex @google/gemini-cli 

    - name: Verify MCP Client Dependencies installation
      run: |
        which claude
        claude --version
        which codex
        codex --version
        which gemini
        gemini --version

    - name: Install project dependencies
      run: uv sync --locked --all-extras --dev

    - name: Install am package locally
      run: uv pip install -e .

    - name: Run tests
      run: uv run pytest tests --cov=wa --cov-report xml --junitxml=junitxml -o junit_family=legacy

    - name: Upload to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test results to Codecov
      if: ${{ !cancelled() }}
      uses: codecov/test-results-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
